<!DOCTYPE html>
<html>
    <head>
        <!-- input styles http://callmenick.com/2014/04/22/various-css-input-text-styles/ -->
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />

        <meta name="msapplication-tap-highlight" content="no" />
        <title>Garage Sale Genius</title>

        <link rel="stylesheet" type="text/css" href="css/Roboto.css" />    
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.3.min.css" /> 
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile.iscrollview.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile.iscrollview-pull.css" />
        <link rel="stylesheet" type="text/css" href="css/gsgenius.css" />
        <!-- from themeroller -->
        <!--
        <link rel="stylesheet" href="themes/sample.min.css" />
        <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
        -->
        
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
        <script type="text/javascript" src="js/jquery-2.1.1.js"></script> 

        <script>
            // use this code in conjuction with data-enhance="false", to turn off styling for jQM elements
            // this code must be present before jQM js is loaded
            $(document).on('mobileinit', function () {
                $.mobile.ignoreContentEnabled = true;
            });
        </script>

        <script type="text/javascript" src="js/jquery.mobile-1.4.3.min.js"></script>
        <script type="text/javascript" src="js/jquery.validate.min.js"></script> 
        <script type="text/javascript" src="js/iscroll.js"></script> 
        <script type="text/javascript" src="js/jquery.mobile.iscrollview.js"></script>
        <script type="text/javascript" src="js/jquery.loadJSON.js"></script> 
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/gsgenius.js"></script>



        <script>
            /*
            $(document).on( "mobileinit", function() {
                console.log('mobileinit started.');
                $.mobile.loader.prototype.options.text = "loading";
                $.mobile.loader.prototype.options.textVisible = false;
                $.mobile.loader.prototype.options.theme = "a";
                $.mobile.loader.prototype.options.html = "";
            });
            */
            
            $(document).ready(function(){
                $(document).on({
                    ajaxStart: function() { 
                        //$.mobile.loading('show'); // shows the default jQM loading spinner
                        console.log('Ajax call started.');
                        },
                    ajaxStop: function() {
                        //$.mobile.loading('hide');
                        console.log('Ajax call ended');
                        }    
                });

                $(document).on('pagecontainershow', function(e, ui) {
                    /*
                    console.log('Switched page from ' + ui.prevPage.attr('id') + ' to ' + ui.toPage.attr('id'));
                    console.log('History stack: ' + $.mobile.navigate.history.stack);
                    console.log('History stack length: ' + $.mobile.navigate.history.stack.length);                    
                    console.log("Current url:" + $.mobile.navigate.history.getActive().url);
                    console.log("Stack: (active index = " + $.mobile.navigate.history.activeIndex + "  previous index: " + $.mobile.navigate.history.previousIndex + " )");

                    console.log('History stack: ' + $.mobile.navigate.history.stack);
                    $.each($.mobile.navigate.history.stack, function (index, val) {
                        console.log(index + "-" + val.url);
                    });
                    */
                });

                $(document).on('pagebeforechange', function(e, ob) {
                    /*
                    console.log('ob.toPage = ' + ob.toPage);
                    if (ob.toPage && (typeof ob.toPage==="string") && ob.toPage.indexOf('address-search-results-map-page') >= 0) {
                        //e.preventDefault();
                    }
                    */
                });
            });
        </script>
    </head>
    <body>
        <!-- As of jQM 1.4, these have been deprecated
        data-role="content". use role="main" class="ui-content" instead
        data-role="fieldcontain". use class="ui-field-contain" instead
        data-role="button". use  class="ui-btn" instead
        -->

        <!--
        ======================
        REUSABLE OBJECTS BELOW
        ======================
        -->          
        
<!--
        <div data-role="panel" id="leftpanel1" data-position="left" data-display="reveal" data-theme="a">

            <h3>Left Panel: Reveal</h3>
            <p>This panel is positioned on the left with the reveal display mode. The panel markup is <em>after</em> the header, content and footer in the source order.</p>
            <p>To close, click off the panel, swipe left or right, hit the Esc key, or use the button below:</p>
            <a href="#demo-links" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-btn-a ui-icon-delete ui-btn-icon-left ui-btn-inline">Close panel</a>

        </div>
-->

    
        

        <!--
        =================
        INTRO PAGES BELOW
        =================
        -->        
                
        <!-- BEGIN PAGE: Select Buy or Sell -->
        <div data-role="page" id="select-buy-or-sell-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
            </div>   

            <div role="main" class="ui-content">
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <a href="#address-search-criteria-page" data-transition="slide"  class="ui-btn" data-inline="false">
                            <img src="img/buy1.png" alt="buy" width="200px" height="200px" />
                        </a>
                    </div>
                    <div class="ui-block-b">
                        <a href="#enter-seller-item-details-page" data-transition="slide"  class="ui-btn" data-inline="false">
                            <img src="img/buy1.png" alt="sell" width="200px" height="200px" />
                        </a>
                    </div>
                </div>
            </div>

            <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>Footer</h3>
            </div>    
        </div> 
        <!-- END PAGE: Select Buy or Sell -->
        
        
        <!--
        =================
        BUYER PAGES BELOW
        =================
        -->


        <!-- BEGIN PAGE: Address search criteria -->
        <div data-role="page" id="address-search-criteria-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
                <a href="#leftpanel1" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-mini">Reveal</a>
            </div>   

             <!-- ajax loading busy indicator popup -->
            <div data-role="popup" id="ajax-modal-popup-address-search" class="ui-corner-none" data-dismissible="false" style="text-align:center; width:240px; height:70px; background-color: #747D7D;">
                <!-- image and text aligned
                <div style="padding:10px;">
                    <img src="img/ajax-loader.gif" style="text-align:left; vertical-align:middle;">
                    Processing
                </div>
                -->
                <div style="padding:10px; align:left;">
                    <img src="img/ajax-loader.gif" style="text-align:left; vertical-align:middle;"/>
                    <!--Processing-->
                </div>
            </div> 

            <div role="main" class="ui-content">
                <h2>Search for Garage Sales</h2>
                <hr class="style-two"/>                
                <!--<h4>1. I am coming from: (choose one)</h4>-->
                <h3>Enter your location or tap <img src="img/gmap-marker1.png" style="text-align:left; vertical-align:bottom; width:22px; height:35px;"/> for your approximate location</h3>
                <p></p>
                <table border="0">
                    <tr>
                        <td>
                            <div data-enhance="false" class="style-4">
                            <input class="text-input" type="text" id="buyerlocation" name="buyerlocation" placeholder="Postal code, Zip code, Intersection or Address"/>
                            </div>
                        </td>
                        <td>
                            <a id="getmygeolocation"><img style="padding-left:16px;" src="img/gmap-marker2.svg" width="50px" height="50px"/></a>
                        </td>
                    </tr>
                </table>
                <!--<a id="getmygeolocation" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a">Get my location</a>-->

                <br/><br/>

                <h3>Within how many kilometers from you?</h3>
                <p></p>
                <!--<input type="range" name="searchradius" id="searchradius" data-track-theme="a" data-theme="a" min="1" max="20" value="1" >-->
                <input type="range" name="searchradius" id="searchradius" data-track-theme="a" data-highlight="true" data-mini="true" data-theme="a" min="1" max="20" value="1" step="1" defaultValue="1">
                <br/><br/>
                
                <!--<input type="button" data-icon="search" value="Search" id="searchaddress"/>-->
                <!-- <a id="searchaddress" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-search ui-btn-icon-left ui-btn-a">Search</a> -->
                <button id="searchaddress" data-enhance="false">Search</button>
                
            </div>

            <!--
            <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>Footer</h3>
            </div>
            --> 
        </div> 
        <script type="text/javascript">
            var searchUrl = 'http://winskee.com/phonegap/garagesalegenius/get-active-garage-sales.php'; 
            var geolocationLatLng;
            var geoLocationFormattedAddress;
            var searchRadius;

    		$(document).on('pagebeforeshow', '#address-search-criteria-page', function(){      
                console.log('pagebeforeshow on address-search-criteria-page triggered.');

                geolocationLatLng = null;
                geoLocationFormattedAddress = null;
                $('#buyerlocation').val('');
                $('#searchradius').val(1);
                $('#searchradius').change();

    			$(document).on('click', '#getmygeolocation', function(){

                    // perform geolocation
                    // geolocation is async so show a progress dialog
                    console.log('Getting buyer geolocation.');
                    $('#ajax-modal-popup-address-search').popup("open");
                    //navigator.notification.loadingStart();
                    navigator.geolocation.getCurrentPosition(geoCodeBuyerLocationSuccess, geoCodeBuyerLocationError);
    			});

    			$(document).on('click', '#searchaddress', function(){ 
                    searchRadius = $('#searchradius').val() * .6214;    // convert into miles
                    console.log('Search radius: ' + searchRadius + ' miles');
                    if (geolocationLatLng == null) {
                        console.log('Buyer location latlng still undefined.');
                        // geocoding is async
                        // geocode the buyer's address
                        $('#ajax-modal-popup-address-search').popup("open");
                        var buyerLocationToGeoCode = $('#buyerlocation').val();
                        console.log('Geocoding buyer location: ' + buyerLocationToGeoCode);
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({'address': buyerLocationToGeoCode}, function(results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                geolocationLatLng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                                geoLocationFormattedAddress = results[0].formatted_address;
                                console.log('Geocoding successful. Buyer location latlng: ' + geolocationLatLng + ' formatted address: ' + geoLocationFormattedAddress);

                                searchUrl = 'http://winskee.com/phonegap/garagesalegenius/get-active-garage-sales.php' + '?latitude=' + results[0].geometry.location.lat() + '&longitude=' + results[0].geometry.location.lng() + '&search_radius=' + searchRadius;

                                performSearch();

                            } else {
                                $('#ajax-modal-popup-address-search').popup("close");
                                console.log('Geocoding failed.  Search aborted.');
                                //alert('Search failed.  Please verify you entered a valid location or check your internet connection.');
                                console.log('Start showing device notification.');
                                navigator.notification.alert(
                                    "Search failed.  Please verify you entered a valid location or check your internet connection.",
                                    geoCodeBuyerLocationAlertDismissed, // callback
                                    'Search',
                                    'OK'
                                );
                                console.log('End showing device notification.');
                            }
                        });                        
                    } else {
                        console.log('Previous Buyer location latlng: ' + geolocationLatLng);
                        console.log('Previous Buyer location formatted address: ' + geoLocationFormattedAddress);

                        // it is possible that the user has changed/edited the buyer address field to an address that is
                        // different than the last geolocated address.  therefore, we should geocode the address field again.

                        // geocoding is async
                        // geocode the buyer's address
                        $('#ajax-modal-popup-address-search').popup("open");
                        var buyerLocationToGeoCode = $('#buyerlocation').val();
                        console.log('Geocoding buyer location: ' + buyerLocationToGeoCode);
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({'address': buyerLocationToGeoCode}, function(results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                geolocationLatLng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                                geoLocationFormattedAddress = results[0].formatted_address;
                                console.log('Geocoding successful. Buyer location latlng: ' + geolocationLatLng + ' formatted address: ' + geoLocationFormattedAddress);

                                searchUrl = 'http://winskee.com/phonegap/garagesalegenius/get-active-garage-sales.php' + '?latitude=' + results[0].geometry.location.lat() + '&longitude=' + results[0].geometry.location.lng() + '&search_radius=' + searchRadius;

                                performSearch();

                            } else {
                                $('#ajax-modal-popup-address-search').popup("close");
                                console.log('Geocoding failed.  Search aborted.');
                                //alert('Search failed.  Please verify you entered a valid location or check your internet connection.');
                                console.log('Start showing device notification.');
                                navigator.notification.alert(
                                    "Search failed.  Please verify you entered a valid location or check your internet connection.",
                                    geoCodeBuyerLocationAlertDismissed, // callback
                                    'Search',
                                    'OK'
                                );
                                console.log('End showing device notification.');
                            }
                        }); 
                    }

    			}); 
    		});

            function geoCodeBuyerLocationSuccess(position) {
                var geoLocationInfo = 'Latitude: ' + position.coords.latitude              + '<br />' +
                            'Longitude: '          + position.coords.longitude             + '<br />' +
                            'Altitude: '           + position.coords.altitude              + '<br />' +
                            'Accuracy: '           + position.coords.accuracy              + '<br />' +
                            'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                            'Heading: '            + position.coords.heading               + '<br />' +
                            'Speed: '              + position.coords.speed                 + '<br />' +
                            'Timestamp: '          + position.timestamp          + '<br />';
                
                console.log('Buyer geolocation found. geoLocationInfo=' + geoLocationInfo);
                console.log('Getting buyer address from geolocation.');
                // get the formatted address from the buyer's latlng
                var geocoder = new google.maps.Geocoder();
                geolocationLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                
                // geocoding is async
                // get the formatted address
                geocoder.geocode({'latLng': geolocationLatLng}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        geoLocationFormattedAddress = results[0].formatted_address;
                        $('#buyerlocation').val(geoLocationFormattedAddress);
                        console.log('Buyer location formatted address: ' + geoLocationFormattedAddress);
                    } else {
                        console.log('Buyer location formatted address not found.');

                    }
                });
                $('#ajax-modal-popup-address-search').popup("close");
                //navigator.notification.loadingStop();
            }

            // geoCodeBuyerLocationError callback receives a PositionError object
            function geoCodeBuyerLocationError(error) {
                $('#ajax-modal-popup-address-search').popup("close");
                console.log('Buyer geolocation not found. error.code=' + error.code + ' error.message=' + error.message);
                //alert('Oops!  Unable to find your location.');
                console.log('Start showing device notification.');
                navigator.notification.alert(
                    "Oops!  Unable to find your location.",
                    geoCodeBuyerLocationAlertDismissed, // callback
                    'Your Location',
                    'OK'
                );
                console.log('End showing device notification.');
            }

            function geoCodeBuyerLocationAlertDismissed() {
                // do something
            }

            function performSearch() {
                console.log('Begin search.');
                console.log('Search url: ' + searchUrl);
                $.ajax({
                    url: searchUrl,
                    async: true,
                    beforeSend: function() {
                        //$.mobile.loading('show', {theme:"a", text:"Getting addresses...", textonly:false, textVisible: true}); // show AJAX spinner
                        $('#ajax-modal-popup-address-search').popup("open");
                    },
                    complete: function() {
                        console.log('Search complete.');
                        $('#ajax-modal-popup-address-search').popup("close");   
                    },  
                    success: function (result) {
                        ajax.parseJSONP(result);
                    },
                    error: function (request,error) {
                        //alert('Search failed.  Please check your internet connection.');
                        console.log('Start showing device notification.');
                        navigator.notification.alert(
                            "Can't seem to reach our servers.  Please check your internet connection.",
                            geoCodeBuyerLocationAlertDismissed, // callback
                            'Search',
                            'OK'
                        );
                        console.log('End showing device notification.');
                    }
                }); 
            }
            var sellersVO = {
    			id : null,
    			sellers : null,
                sellerDetail: null
    		}
    		var ajax = {  
    			parseJSONP:function(result) {  
    				sellersVO.sellers = result;
                    
                    console.log('number of sellers found: ' + sellersVO.sellers.length);

    				// show the results page
    				$(':mobile-pagecontainer').pagecontainer('change', '#address-search-results-page', {
    				    reload: false
    				});

    			}
    		}
        </script>
        <!-- END PAGE: Address search criteria -->

        
        <!-- BEGIN PAGE: Address search results -->
        <div data-role="page" id="address-search-results-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
                <!--
                <a href="#address-search-results-map-page" data-icon="navigation" class="ui-btn-right">View in map</a>
                -->
            </div>   

            <div role="main" class="ui-content">
                <div id="nosellersfound" style="display:none;">
                    <h3></h3>
                </div>
                <div class="listview-wrapper" data-iscroll>
                    <ul data-role="listview" id="address-list" data-inset="true" data-icon="false">
                    </ul>
                </div>
            </div>

            <div id="mapview-results" data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>Map View</h3>
            </div>    
        </div> 
        <script type="text/javascript">
            $(document).on('vclick', '#mapview-results', function(){ 
                console.log('Map view of results requested.');
                // show the search results on the map
                $(':mobile-pagecontainer').pagecontainer('change', '#address-search-results-map-page', {
                    reload: false,
                    changeHash: false
                });
            });
                       
            $(document).on('pagebeforeshow', '#address-search-results-page', function(){
                console.log('pagebeforeshow on address-search-results-page triggered.');
                $('#nosellersfound').hide();
                $('#nosellersfound').html('');

                // populate search results
                $('#address-list').empty();
                
                console.log('number of sellers found: ' + sellersVO.sellers.length);
                if (sellersVO.sellers.length == 0) {
                    $('#nosellersfound').html('<h3>Sorry, no sellers found within ' + $('#searchradius').val() + ' kilometer(s) of your location!' );
                    $('#nosellersfound').show();
                }
                $.each(sellersVO.sellers, function(i, row) {

                    // append the gui_selected attribute that we will use to store the user's selection of this address
                    row.gui_selected = false;
                    console.log('Seller JSON: ' + JSON.stringify(row));
                    
                    // assemble the custom address row
                    var addressStaticGMapUrl = 'http://maps.googleapis.com/maps/api/staticmap?center=' + row.latitude + ',' + row.longitude + '&zoom=17&size=100x100&maptype=roadmap&markers=' + row.latitude + ',' + row.longitude;

                    $('#address-list').append('<li><a href="" data-id="' + row.id + '">' + '<img src="' + addressStaticGMapUrl + '"/>'  + '<h3>' + row.formatted_address + '</h3><p>When:&nbsp;' + row.start_time + '&nbsp;-&nbsp;' + row.end_time + '</p><p style="color:green;">Approx. ' + truncateDecimals(row.distance *1.60934, 2) + ' km(s) away</p></a></li>');
                });
                $('#address-list').listview('refresh');
                $(".listview-wrapper").iscrollview("refresh");

                // click on a search item result
                $(document).on('vclick', '#address-list li a', function(){  
                    sellersVO.id = $(this).attr('data-id');

                    $.each(sellersVO.sellers, function(i, row) {
                        // toggle select/deselect address
                        if (row.id == sellersVO.id) {
                            sellersVO.sellerDetail = row;   // keep a reference to the selected address
                            if (row.gui_selected) {
                                row.gui_selected = false;
                                console.log("Deselected " + row.formatted_address);
                            } else {
                                row.gui_selected = true;
                                console.log("Selected " + row.formatted_address);
                            }
                            return false;   // exit loop                            
                        }

                    });

                    //$(this).attr('data-theme','a').trigger('refresh');
                    $(':mobile-pagecontainer').pagecontainer('change', '#view-seller-item-details-page', {
                        reload: false
                    });
                });
            });
        </script>
        <!-- END PAGE: Address search results -->


        <!-- BEGIN PAGE: Address search results in map -->
        <div data-role="page" id="address-search-results-map-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
            </div>   

            <div data-role="content" id="search-results-map-div" style='position:relative; padding:0;'>
                <div id='search-results-map-house-number'></div>
                <div id="search-results-map-canvas" style="height:100%"></div>
            </div>

            <!--
            <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                <a href="#address-search-results-map-page" data-icon="navigation" class="ui-btn-left" data-rel="back">Back</a>
            </div>   
            -->
            
            <div id="listview-results" data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>List View</h3>
            </div>               
        </div> 
        <script>
            var lastSellerInfoWindow;
            
            $(document).on('vclick', '#listview-results', function(){ 
                console.log('List view of results requested.');
                // show the search results page
                $(':mobile-pagecontainer').pagecontainer('change', '#address-search-results-page', {
                    reload: false,
                    changeHash: false
                });
            });
 
            $(document).on('pagehide', '#address-search-results-map-page', function(event){ 
                console.log('pagehide on address-search-results-map-page triggered.');
                /*
                var page = event.target;
                page.remove();  //removes page from DOM
                console.log('Removed page address-search-results-map-page from history.');
                */
            });

            $(document).on('pageshow', '#address-search-results-map-page',function(e,data) {   
                console.log('Adjusting map div height.');
                $('#search-results-map-div').height(getRealContentHeight());
                // This is the minimum zoom level that we'll allow
                var minZoomLevel = 12;

                var searchResultsMap = new google.maps.Map(document.getElementById('search-results-map-canvas'), {
                    zoom: minZoomLevel,
                    center: new google.maps.LatLng(38.50, -90.50),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    panControl: false,
                    mapTypeControl: false,
                    panControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    scaleControl: false,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    }
                });

                var bounds = new google.maps.LatLngBounds();
                console.log('Put buyer on map.');
                var marker = makeGMapMarker(searchResultsMap, geolocationLatLng, b2sDrivingDirectionsIcons.start, '');
                bounds.extend(geolocationLatLng);

                var contentString = '<div id="infowindow-content">' + '<span class="infowindow-seller-address">Your approx. location:<hr/><b>' + geoLocationFormattedAddress + '</b></span>' + '</div>';
                var infoWindow = new google.maps.InfoWindow({

                });
                google.maps.event.addListener(marker, 'click', function() {
                    if (lastSellerInfoWindow) lastSellerInfoWindow.close();
                    infoWindow.open(searchResultsMap, marker);
                    lastSellerInfoWindow = infoWindow;
                });

                console.log('Put sellers on map.');
                $.each(sellersVO.sellers, function(i, row) {
                    var latlng = new google.maps.LatLng(row.latitude, row.longitude);
                    var marker = makeGMapMarker(searchResultsMap, latlng, b2sDrivingDirectionsIcons.end, '');
                    bounds.extend(latlng);

                    var contentString = '<div id="infowindow-content">' + '<span class="infowindow-seller-address"><b>' + row.formatted_address + '</b></span>' + '<hr/>Starting: ' + row.start_time + '</div>';
                    var infoWindow = new google.maps.InfoWindow({
                        content: contentString
                    });
                    google.maps.event.addListener(marker, 'click', function() {
                        if (lastSellerInfoWindow) lastSellerInfoWindow.close();
                        infoWindow.open(searchResultsMap, marker);
                        lastSellerInfoWindow = infoWindow;
                    });
                });
                google.maps.event.addListenerOnce(searchResultsMap, 'bounds_changed', function(event) {
                    if (this.getZoom() > 15) {
                        this.setZoom(15);
                    }
                });
                searchResultsMap.fitBounds(bounds); //async
            });
        </script>
        <!-- END PAGE: Address search results in map -->
        
        
        
        <!--
        ==================
        SELLER PAGES BELOW
        ==================
        -->

        <!-- BEGIN PAGE: Email explanation -->
        <!-- END PAGE: Email explanation -->
        
        
        <!-- BEGIN PAGE: Enter Seller item details -->
        <div data-role="page" id="enter-seller-item-details-page">
            <form id="seller-form1">
                <div data-role="header" data-position="fixed">
                    <h1>gsgenius</h1>
                </div>   

                <!-- A popup div has to be nested inside the same page as the link! -->
                <div data-role="popup" id="why-email-is-required" class="ui-content" data-theme="b" data-dismissible="false">
                    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                    <h4>Why do I need to provide my email?</h4>
                    <p>
                        Upon submitting this form, an email will be sent to you which contains a link to approve and activate this garage sale.<br/>
                        This ensures that no other individual can post a Garage Sale with your address without your knowledge and approval.
                    </p>
                    <br/>
                    <h4>Our Email Guarantee</h4>
                    <p>
                        Your email will be used for the sole purpose of sending you the link to activate this Garage Sale.<br/>
                        We will never, ever sell, distribute nor contact you for any other purposes other than sending you the activation link.
                    </p>
                </div>

                 <!-- ajax loading busy indicator popup -->
                <div data-role="popup" id="ajax-modal-popup-save-new-address" class="ui-corner-all" data-dismissible="false" style="text-align:center; width:200px; height:70px;">
                    <div class="box300 border" style="padding:10px;">
                        <img src="img/ajax-loader.gif" style="text-align:left; vertical-align:middle;">
                        Processing
                    </div>
                </div> 
              
                <div role="main" class="ui-content">
                    <h2>Enter your Garage Sale details</h2>
                    <hr class="style-two"/> 
                        <div class="ui-field-contain">
                            <div>
                                Email:<a href="#why-email-is-required" data-rel="popup">Info</a>
                            </div>
                            <div data-enhance="false" class="style-4">
                                <input type="email" name="email" id="email" placeholder="Enter your email"/>
                            </div>
                        </div>
                        <div class="ui-field-contain">
                            <label for="address">Address:</label>
                            <div data-enhance="false" class="style-4">
                                <input type="text" id="address" name="address" placeholder="Enter your address"/>
                            </div>
                        </div>
                        <div class="ui-field-contain">
                            <label for="starttime">Start Time:</label>
                            <div data-enhance="false" class="style-4">
                                <input type="text" id="starttime" name="starttime" placeholder="Enter Start Time"/>
                            </div>
                        </div>
                        <div class="ui-field-contain">
                            <fieldset data-role="controlgroup">
                                <legend>Select all that apply to your Garage Sale:</legend>

                                <label for="multifamily">Multi-Family</label>
                                <input type="checkbox" name="multifamily" id="multifamily" value="N">
                                <label for="parkonstreet">Park on Street</label>
                                <input type="checkbox" name="parkonstreet" id="parkonstreet" value="N">
                                <label for="parkatvisitorsparking">Park at Visitors Parking</label>
                                <input type="checkbox" name="parkatvisitorsparking" id="parkatvisitorsparking" value="N">	
                                <label for="earlybirdsspecial">Early Birds Specials available</label>
                                <input type="checkbox" name="earlybirdsspecial" id="earlybirdsspecial" value="N">	
                                <label for="canceledwhenraining">Cancelled when raining</label>
                                <input type="checkbox" name="canceledwhenraining" id="canceledwhenraining" value="N">	
                                <label for="cashonly">Cash only</label>
                                <input type="checkbox" name="cashonly" id="cashonly" value="cashonly">	
                                <label for="refreshementsprovided">Simple refreshments provided</label>
                                <input type="checkbox" name="refreshementsprovided" id="refreshementsprovided" value="N">	
                                <label for="surprisefreebies">Surprise Freebies available</label>
                                <input type="checkbox" name="surprisefreebies" id="surprisefreebies" value="N">	
                                <label for="collectorsitems">Collector's Items</label>
                                <input type="checkbox" name="collectorsitems" id="collectorsitems" value="N">	
                                <input type="hidden" name="source" id="source" value="MOBILEAPP" />
                                <input type="hidden" name="sellerlatitude" id="sellerlatitude" />
                                <input type="hidden" name="sellerlongitude" id="sellerlongitude" />
                                <input type="hidden" name="formattedaddress" id="formattedaddress" />
                            </fieldset>
                        </div>
                        <div class="ui-field-contain">
                            <label for="messagetobuyers">Additional message to buyers:</label>
                            <textarea id="messagetobuyers" name="messagetobuyers" placeholder="eg: Specify your specialty items"></textarea>
                        </div>
                </div>

                <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                    <input type="button" data-icon="delete" value="Cancel" id="cancel"/>    
                    <input type="submit" data-icon="check" value="Submit" id="submit"/>
                </div>
            </form>

        </div> 

        <script>
            $('#seller-form1').validate({
                rules: {
                    address: {
                        required: true
                    },
                    email: {
                        required: true
                    }
                },
                messages: {
                    address: {
                        required: "Please enter your address."
                    },
                    email: {
                        required: "Please enter your email."
                    }
                },
                errorPlacement: function (error, element) {
                    error.appendTo(element.parent().prev());
                    /*error.insertAfter( element.parent() );*/
                },
                submitHandler: function (form) {
                    // geocode the seller's address
                    var geocoder = new google.maps.Geocoder();
                    var addressToGeoCode = $("#address").val();
                    
                    // geocoding is async
                    // submit the seller form only when the address is valid
                    geocoder.geocode({'address': addressToGeoCode}, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {

                            /*
                            mysql data type
                            Latitudes range from -90 to +90 (degrees), so DECIMAL(10, 8) is ok for that, but longitudes range from -180 to +180 (degrees) so you need DECIMAL(11, 8). The first number is the total number of digits stored, and the second is the number after the decimal point.

                            In short: lat DECIMAL(10, 8) NOT NULL, lng DECIMAL(11, 8) NOT NULL
                            */

                            $('#sellerlatitude').val(results[0].geometry.location.lat());
                            $('#sellerlongitude').val(results[0].geometry.location.lng());
                            $('#formattedaddress').val(results[0].formatted_address);
                            console.log('formatted address: ' + results[0].formatted_address);

                            // submit the seller form
                            $.ajax({
                                url: 'http://winskee.com/phonegap/garagesalegenius/add-garage-sale.php', 
                                type: 'POST', 
                                dataType: 'json', // request type html/json/xml
                                data: $('#seller-form1').serialize(), 
                                beforeSend: function() {
                                    $('#ajax-modal-popup-save-new-address').popup("open");
                                },
                                complete: function() {
                                    $('#ajax-modal-popup-save-new-address').popup("close");
                                },
                                success: function(data) {
                                    // show the success page
                                    $(':mobile-pagecontainer').pagecontainer('change', '#thank-you-for-posting-page', {
                                        reload: false
                                    });
                                },
                                error: function(e) {
                                    console.log(e)
                                }
                            });

                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                    
                    return false;
                }

            });
        </script>
        <!-- END PAGE: Enter Seller item details -->


        <!-- BEGIN PAGE: Confirm add Seller item details popup -->
        <!--
        <a href="#popupDialog" data-rel="popup" data-position-to="window" data-transition="pop" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-delete ui-btn-icon-left ui-btn-b">Confirm Garage Sale</a>
        <div data-role="popup" id="popupDialog" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
            <div data-role="header" data-theme="a">
                <h1>Delete Page?</h1>
            </div>
            <div role="main" class="ui-content">
                <h3 class="ui-title">Are you sure you want to delete this page?</h3>
                <p>This action cannot be undone.</p>
                <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
                <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow">Delete</a>
            </div>
        </div>
        -->
        <!-- BEGIN PAGE: Confirm add Seller item details popup -->

        
        <!-- BEGIN PAGE: View Seller item details -->
        <div data-role="page" id="view-seller-item-details-page">
            <form id="ro-seller-form1">
                <div data-role="header" data-position="fixed">
                    <h1>gsgenius</h1>
                </div>   
                
                <!-- prompt for buyer address popup -->
                <div data-role="popup" id="buyer-address-popup" data-theme="a" class="ui-corner-all" data-dismissible="false">
                    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                    <div style="padding:10px 20px;text-align: center;">
                        <h3>Enter your address or location</h3>
                        <label for="buyer_address" class="ui-hidden-accessible">Address:</label>
                        <input type="text" name="buyer_address" id="buyer_address" value="" placeholder="" data-theme="a">
                        <button class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check ui-btn-inline" onclick="geoCodeBuyerAddress();">Go!</button>
                    </div>
                </div>

                <div role="main" class="ui-content">
                    <h2 id="ro_address"></h2>
                    <h4 id="ro_start_time"></h4>
                    <hr class="style-two"/> 

                    <div id="ro_message">Message from seller: </div>
                    <p></p>

                    <div id="ro_multi_family" style="display:none;">Multi-Family&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_street_parking" style="display:none;">Park on Street&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_visitors_parking" style="display:none;">Park at Visitors Parking&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_early_bird" style="display:none;">Early Birds Specials available&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_rain_cancelled" style="display:none;">Cancelled when raining&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div> 
                    <div id="ro_cash_only" style="display:none;">Cash only&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_refreshments" style="display:none;">Simple refreshments provided&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_freebies" style="display:none;">Surprise freebies available&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    <div id="ro_collectors_items" style="display:none;">Collector's Items&nbsp;<img src="img/checkmark1.png" width="36px" height="36px"/></div>
                    
                    <!-- buyer to seller directions -->

                    <a id="view-buyer-seller-directions-map" href="#buyer-seller-driving-directions-map-page" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-map ui-btn-icon-left ui-btn-a">View Map</a>
                   
                    <!-- <button id="view-buyer-seller-directions-map" data-enhance="false" style="margin-top:4px;margin-bottom:4px;">View Map</button> -->

                    <div><h3 id="directions-to-seller-header">Driving directions to Seller's address</h3></div>

                    <div id="b2s-map-canvas" style="display:none;width:100%;height:400px;"></div>
                    <div id="b2s-directions-panel" style="width:100%;"></div>
                    
                </div>

                <!-- right panel menu -->
<!--
                <div class="panel right" data-role="panel" data-position="right" data-display="overlay" id="panel-02">
                    <ul>
                        <li><a href="#" title="John Doe"><span class="avatar"><img src="img/mambows_120.jpg" width="30" height="30"></span>John Doe</a></li>
                        <li><a href="#" title="Jessy Doe"><span class="avatar"><img src="img/mkalalang_120.jpg" width="30" height="30"></span>Jessy Doe</a></li>
                    </ul>
                </div>
-->
                
                <!--
                 <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                    <input type="button" data-icon="delete" value="Cancel" id="cancel"/>    
                    <input type="submit" data-icon="check" value="Submit" id="submit"/>
                </div>
                -->
            </form>
        </div> 

        <script>
            // legend: b2s = buyer to seller
            var b2sDirectionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
            var b2sDirectionsService = new google.maps.DirectionsService();
            var b2sMap;
            var b2sDrivingDirectionsRequest;
            var buyerAddressLatLng;
            var selectedSellerAddressLatLng;
            var b2sDrivingDirectionsIcons = {
                start: new google.maps.MarkerImage('img/mapicon-buyer.png'),
                end: new google.maps.MarkerImage('img/mapicon-home.png')
            };

            $(document).on('vclick', '#view-buyer-seller-directions-map', function(){ 
                console.log('Map view of seller location requested.');
                // show the seller location on the map
                $(':mobile-pagecontainer').pagecontainer('change', '#buyer-seller-driving-directions-map-page', {
                    reload: false
                });
            });

            $(document).on('pagehide', '#view-seller-item-details-page', function(event){ 
                console.log('pagehide on view-seller-item-details-page triggered.');
            });

            $(document).on('pageshow', '#view-seller-item-details-page',function(e,data) {
                // set and display the seller's detail info
                
                /* couldn't get it to work for checkboxes, even though JSON object contains boolean values
                console.log('Populating seller form from JSON: ' + JSON.stringify(sellersVO.sellerDetail));
                $('form').loadJSON(sellersVO.sellerDetail); // the name of the read-only form is ro-seller-form1, but it seems 'form' must be passed in.
                */
                
                console.log('Populating seller form from JSON: ' + JSON.stringify(sellersVO.sellerDetail));
                $('#ro_address').html(sellersVO.sellerDetail.formatted_address);
                $('#ro_start_time').html(sellersVO.sellerDetail.start_time);
                $('#ro_message').html('Message from seller: ' + sellersVO.sellerDetail.message);
                (sellersVO.sellerDetail.multi_family)? $('#ro_multi_family').show() : $('#ro_multi_family').hide();
                (sellersVO.sellerDetail.street_parking)? $('#ro_street_parking').show() : $('#ro_street_parking').hide();
                (sellersVO.sellerDetail.visitors_parking)? $('#ro_visitors_parking').show() : $('#ro_visitors_parking').hide();
                (sellersVO.sellerDetail.early_bird)? $('#ro_early_bird').show() : $('#ro_early_bird').hide();
                (sellersVO.sellerDetail.rain_cancelled)? $('#ro_rain_cancelled').show() : $('#ro_rain_cancelled').hide();
                (sellersVO.sellerDetail.cash_only)? $('#ro_cash_only').show() : $('#ro_cash_only').hide();
                (sellersVO.sellerDetail.refreshments)? $('#ro_refreshments').show() : $('#ro_refreshments').hide();
                (sellersVO.sellerDetail.freebies)? $('#ro_freebies').show() : $('#ro_freebies').hide();
                (sellersVO.sellerDetail.collectors_items)? $('#ro_collectors_items').show() : $('#ro_collectors_items').hide();
        
                selectedSellerAddressLatLng = new google.maps.LatLng(sellersVO.sellerDetail.latitude, sellersVO.sellerDetail.longitude);
                
                console.log('Rendering buyer to seller map');
                $('#b2s-map-div').height(getRealContentHeight() / 2);   // TODO: need to know what height to set the div to, and not just guessing

                // set buyer and seller directions request
                /*
                b2sDrivingDirectionsRequest = {
                    origin: geolocationLatLng,
                    destination: selectedSellerAddressLatLng,
                    travelMode: google.maps.TravelMode.DRIVING
                };
                */
                b2sDrivingDirectionsRequest = {
                    origin: geoLocationFormattedAddress,
                    destination: sellersVO.sellerDetail.formatted_address,
                    travelMode: google.maps.TravelMode.DRIVING
                };               
                initBuyer2SellerDrivingDirections();

            });
            
            var initBuyer2SellerDrivingDirections = function() {
                console.log('Initializing buyer to seller driving directions.');

                // get driving directions from buyer to seller
                // show map and directions from buyer to seller
                console.log('Calling DirectionsService.route to get text directions.');
                b2sDirectionsService.route(b2sDrivingDirectionsRequest, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        console.log('Got the directions.');
                        console.log('Display the directions.');
                        $('#b2s-directions-panel').html('');    // clear previous directions
                        b2sDirectionsDisplay.setPanel(document.getElementById('b2s-directions-panel'));
                        b2sDirectionsDisplay.setDirections(response);

                    } else {
                        console.log('Failed to get the directions. status = ' + status);
                        $('#b2s-directions-panel').html("<br>Sorry, no driving route found!  Map displays the seller's address.");
                    }
                });

            }

            var geoCodeBuyerAddress = function() {
                $("#buyer-address-popup").popup("close");
                buyerAddressToGeoCode = $("#buyer_address").val();

                // geocoding is async
                // geocode the buyer's address
                console.log('Geocoding buyer address: ' + buyerAddressToGeoCode);
                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({'address': buyerAddressToGeoCode}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        console.log('Geocoding successful.');
                        buyerAddressLatLng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                        
                        b2sDrivingDirectionsRequest = {
                            origin: buyerAddressLatLng,
                            destination: selectedSellerAddressLatLng,
                            travelMode: google.maps.TravelMode.DRIVING
                        };

                        initBuyer2SellerDrivingDirections();
                    } else {
                        console.log('Geocoding failed. status = ' + status);
                    }
                });


            }

            var makeGMapMarker = function (map, position, icon, title) {
                var marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: icon,
                    title: title
                });
                return marker;
            }
        </script>
        <!-- END PAGE: View Seller item details -->
        

        <!-- BEGIN PAGE: View Buyer to Seller driving directions in map -->
        <div data-role="page" id="buyer-seller-driving-directions-map-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
                <a href="#address-search-results-map-page" data-icon="navigation" class="ui-btn-left" data-rel="back">Back</a>
            </div>   

            <div data-role="content" id="buyer-seller-driving-directions-map-div">
                <div id="b2s-driving-directions-map-canvas" style="height:400px;width:100%;"></div>
            </div>

            <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>Footer</h3>
            </div>    
        </div> 
        <script>
            var b2sDirectionsMap;

            $(document).on('pageshow', '#buyer-seller-driving-directions-map-page',function(e,data) {   
                $('#buyer-seller-driving-directions-map-div').height(getRealContentHeight());

                /*
                console.log('Copying map from previous page div to map div on this page.');
                $('#b2s-map-canvas').css('display', 'block');
                var mapNode = b2sMap.getDiv();
                $('#b2s-driving-directions-map-canvas').append(mapNode);
                */

                $(document).on('pagehide', '#buyer-seller-driving-directions-map-page', function(event){ 
                    console.log('pagehide on buyer-seller-driving-directions-map-page triggered.');
                });

                console.log('Creating buyer to seller driving directions map.');
                b2sDirectionsMap = new google.maps.Map(document.getElementById('b2s-driving-directions-map-canvas'), {
                    zoom: 12,
                    center: selectedSellerAddressLatLng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    panControl: false,
                    mapTypeControl: false,
                    panControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    scaleControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    }
                });

                b2sDrivingDirectionsRequest = {
                    origin: geoLocationFormattedAddress,
                    destination: sellersVO.sellerDetail.formatted_address,
                    travelMode: google.maps.TravelMode.DRIVING
                }; 

                initBuyer2SellerMapDirections();
            });

            var initBuyer2SellerMapDirections = function() {
                console.log('Calling DirectionsService.route to show map route.');
                b2sDirectionsService.route(b2sDrivingDirectionsRequest, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        console.log('Got the directions.');

                        console.log('Make the buyer and seller driving directions markers.');
                        console.log('Put buyer on map.');
                        var buyerMarker = makeGMapMarker(b2sDirectionsMap, geolocationLatLng, b2sDrivingDirectionsIcons.start, "You");
                        var contentString = '<div id="infowindow-content">' + '<span class="infowindow-seller-address">Your approx. location:<hr/><b>' + geoLocationFormattedAddress + '</b></span>' + '</div>';
                        var infoWindow = new google.maps.InfoWindow({
                            content: contentString
                        });
                        google.maps.event.addListener(buyerMarker, 'click', function() {
                            if (lastSellerInfoWindow) lastSellerInfoWindow.close();
                            infoWindow.open(b2sDirectionsMap, buyerMarker);
                            lastSellerInfoWindow = infoWindow;
                        });

                        console.log('Put seller on map.');
                        var sellerMarker = makeGMapMarker(b2sDirectionsMap, selectedSellerAddressLatLng, b2sDrivingDirectionsIcons.end, "Seller");
                        var contentString = '<div id="infowindow-content">' + '<span class="infowindow-seller-address"><b>' + sellersVO.sellerDetail.formatted_address + '</b></span>' + '<hr/>Starting: ' + sellersVO.sellerDetail.start_time + '</div>';
                        var infoWindow = new google.maps.InfoWindow({
                            content: contentString
                        });
                        google.maps.event.addListener(sellerMarker, 'click', function() {
                            if (lastSellerInfoWindow) lastSellerInfoWindow.close();
                            infoWindow.open(b2sDirectionsMap, sellerMarker);
                            lastSellerInfoWindow = infoWindow;
                        });
                        
                        console.log('Display the map route.');
                        b2sDirectionsDisplay.setMap(b2sDirectionsMap);
                        b2sDirectionsDisplay.setDirections(response);
                    } else {
                        console.log("Failed to get directions.  Default map to seller's address.");
                        console.log('Placing map marker for ' + sellersVO.sellerDetail.formatted_address);
                        makeGMapMarker(b2sDirectionsMap, selectedSellerAddressLatLng, b2sDrivingDirectionsIcons.end, 'Seller');
                    }
                });
            }
        </script>
        <!-- END PAGE: View Buyer to Seller driving directions in map -->


        <!-- BEGIN PAGE: Thank you for posting -->
        <div data-role="page" id="thank-you-for-posting-page">
            <div data-role="header" data-position="fixed">
                <h1>gsgenius</h1>
            </div>   

            <div role="main" class="ui-content post-thank-you">
                Thank You!<p></p>
                Your garage sale is now posted.<p></p>
                Good luck!<p></p>
                Please tell your friends about this app!  
            </div>

            <div data-role="footer" data-position="fixed" data-tap-toggle="false">
                <h3>Footer</h3>
            </div>    
        </div> 
        <!-- END PAGE: Enter Address or Get my location page -->



    </body>
</html>
